---
- name: setup secrets
  hosts: atomichosts

  vars_files:
    - vault.yml
    - vars.yml

  tasks:
    - name: make sure directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: 0755
      with_items:
        - /var/kubernetes
        - /var/kubernetes/secrets
  
    - name: template out secret files
      template:
        src: templates/secrets.j2
        dest: /var/kubernetes/secrets/{{ item }}.yml
      with_items: "{{ secrets }}"
  
    - name: run create secret
      command: /usr/bin/kubectl create -f /var/kubernetes/secrets/{{ item }}.yml
      register: createsecrets
      with_items: "{{ secrets }}"
      failed_when: false
      changed_when: false
      tags: [ debug ]

    - name: verify secret creation
      fail:
        msg: "failed creating secret {{ item }}"
      when: "item.rc == 1 and 'already exists' not in item.stderr"
      no_log: "{{ secret_expose | default(true) }}"
      with_items: "{{ createsecrets.results }}"
      tags: [ debug ]
